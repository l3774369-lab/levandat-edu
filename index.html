<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPro VIP MAX - Version 2.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #db2777;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #cbd5e1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius: 12px;
        }

        .dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --primary-light: rgba(79, 70, 229, 0.2);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; font-size: 16px; line-height: 1.5; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .flex-gap { display: flex; gap: 10px; align-items: center; }
        
        /* HEADER */
        .header { background: var(--bg-card); padding: 15px 30px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .brand { font-size: 1.6rem; font-weight: 800; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
        
        /* BUTTONS & INPUTS */
        button { cursor: pointer; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.4); }
        .btn-primary:hover { opacity: 0.9; box-shadow: 0 6px 20px rgba(79, 70, 229, 0.23); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 40px; height: 40px; }

        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: var(--text-sub); }
        .input-group input { padding-left: 40px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .quiz-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .quiz-item:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .quiz-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--primary-light); color: var(--primary); font-weight: bold; }

        /* TABLE */
        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        th { color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; background: var(--bg-body); }
        tr:last-child td { border-bottom: none; }
        
        /* TOAST */
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 10px; min-width: 300px; animation: slideIn 0.3s ease-out; color: var(--text-main); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* EXAM STYLES */
        .question-card { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border); border-radius: 16px; background: var(--bg-card); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .q-header { font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; color: var(--text-main); line-height: 1.6; }
        .q-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px; }
        .opt-row { display: flex; align-items: center; padding: 15px 20px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; background: var(--bg-body); }
        .opt-row:hover { border-color: #a5b4fc; background: #fff; }
        .opt-row.selected { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 1px var(--primary); }
        .opt-row input[type="radio"] { width: 20px; height: 20px; margin: 0 15px 0 0; accent-color: var(--primary); cursor: pointer; }
        .opt-text { font-size: 1rem; color: var(--text-main); user-select: none; flex: 1; }
        .sa-input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 10px; background: var(--bg-body); }
        .sa-input:focus { border-color: var(--primary); background: #fff; }
        #timer-box { font-variant-numeric: tabular-nums; font-weight: 800; font-size: 1.4rem; color: var(--danger); background: rgba(239, 68, 68, 0.1); padding: 8px 20px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* MODAL (OTP) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius); width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; border: 1px solid var(--border); }

    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- MODAL OTP -->
    <div id="modal-otp" class="modal-overlay hidden">
        <div class="modal-card">
            <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h3>Xác thực OTP</h3>
            <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px;">
                Mã xác thực đã được gửi đến thiết bị của bạn.<br>(Check thông báo trình duyệt)
            </p>
            
            <div id="otp-mode-reset" class="hidden" style="margin-bottom: 15px;">
                <input type="password" id="new-password-input" placeholder="Nhập mật khẩu mới">
            </div>

            <input type="text" id="otp-input" placeholder="Nhập mã 6 số (VD: 123456)" style="text-align: center; font-size: 1.2rem; letter-spacing: 2px; font-weight: bold; margin-bottom: 20px;">
            
            <button class="btn-primary" style="width: 100%;" onclick="auth.submitOTP()">XÁC NHẬN</button>
            <button class="btn-outline" style="width: 100%; margin-top: 10px;" onclick="$('#modal-otp').classList.add('hidden')">Hủy bỏ</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="brand" onclick="app.goHome()"><i class="fas fa-graduation-cap"></i> EduPro MAX</div>
        <div class="flex-gap">
            <button class="btn-icon btn-outline" onclick="app.toggleTheme()" title="Đổi giao diện">
                <i class="fas fa-adjust"></i>
            </button>
            <div id="user-area" class="flex-gap"></div>
        </div>
    </header>

    <div class="container">

        <!-- 1. AUTHENTICATION -->
        <div id="view-auth" class="card" style="max-width: 500px; margin: 40px auto;">
            <div style="text-align:center; margin-bottom:30px">
                <h1 style="background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin:0">Xin Chào</h1>
                <p style="color:var(--text-sub)">Hệ thống thi trắc nghiệm trực tuyến 4.0</p>
            </div>
            
            <div id="auth-forms">
                <!-- Login -->
                <div id="form-login">
                    <div class="input-group">
                        <i class="fas fa-user"></i>
                        <input type="text" id="l-user" placeholder="Tên đăng nhập">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="l-pass" placeholder="Mật khẩu">
                    </div>
                    <div style="text-align: right; margin-bottom: 15px;">
                        <a href="#" onclick="auth.forgotPass()" style="font-size: 0.9rem; color: var(--text-sub);">Quên mật khẩu?</a>
                    </div>
                    <button class="btn-primary" style="width:100%; padding:14px" onclick="auth.login()">ĐĂNG NHẬP NGAY</button>
                    <p style="text-align:center; margin-top:20px; font-size:0.9rem">
                        Chưa có tài khoản? <a href="#" onclick="auth.switch('register')" style="color:var(--primary); font-weight:bold">Đăng ký miễn phí</a>
                    </p>
                </div>
                <!-- Register -->
                <div id="form-register" class="hidden">
                    <div class="input-group">
                        <i class="fas fa-font"></i>
                        <input type="text" id="r-name" placeholder="Họ và tên đầy đủ">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-user-tag"></i>
                        <input type="text" id="r-user" placeholder="Tên đăng nhập (viết liền không dấu)">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="r-email" placeholder="Địa chỉ Email (để nhận OTP)">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="r-phone" placeholder="Số điện thoại (để nhận OTP)">
                    </div>
                    <div class="input-group">
                        <i class="fas fa-key"></i>
                        <input type="password" id="r-pass" placeholder="Mật khẩu (có chữ Hoa & ký tự đặc biệt)">
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px; padding-left:10px">
                        * Mật khẩu cần có ít nhất 1 chữ in hoa và 1 ký tự đặc biệt (VD: @, #, !, *...)
                    </div>
                    
                    <button class="btn-primary" style="width:100%; padding:14px" onclick="auth.preRegister()">GỬI MÃ XÁC THỰC</button>
                    <p style="text-align:center; margin-top:20px; font-size:0.9rem">
                        Đã có tài khoản? <a href="#" onclick="auth.switch('login')" style="color:var(--primary); font-weight:bold">Quay lại đăng nhập</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- 2. TEACHER DASHBOARD -->
        <div id="view-teacher" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background:#6366f1"><i class="fas fa-folder-open"></i></div>
                    <div class="stat-info"><h4>Tổng đề thi</h4><p id="stat-quizzes">0</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#ec4899"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><h4>Học sinh</h4><p id="stat-students">0</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#10b981"><i class="fas fa-chart-line"></i></div>
                    <div class="stat-info"><h4>Lượt làm bài</h4><p id="stat-attempts">0</p></div>
                </div>
            </div>

            <div class="card flex-between" style="padding:15px">
                <div class="flex-gap" style="flex:1">
                    <i class="fas fa-search" style="color:var(--text-sub)"></i>
                    <input type="text" id="t-search" placeholder="Tìm kiếm đề thi..." onkeyup="teacher.renderList()" style="border:none; padding:5px; background:transparent; width:100%">
                </div>
                <div class="flex-gap">
                    <button class="btn-outline" onclick="teacher.showUsers()"><i class="fas fa-user-friends"></i> QL Học sinh</button>
                    <button class="btn-primary" onclick="app.router('create-quiz')"><i class="fas fa-plus-circle"></i> Tạo đề mới</button>
                    <button class="btn-outline" onclick="dataMgr.exportData()" title="Backup"><i class="fas fa-cloud-download-alt"></i></button>
                    <label class="btn-outline" style="cursor:pointer; display:flex; align-items:center; height:38px; margin:0">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <input type="file" hidden onchange="dataMgr.importData(this)">
                    </label>
                </div>
            </div>

            <h3 style="margin: 20px 0 10px"><i class="fas fa-list"></i> Danh sách đề thi</h3>
            <div id="teacher-list" class="quiz-grid"></div>
        </div>

        <!-- TEACHER VIEW USERS -->
        <div id="view-users" class="hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:20px">
                    <h3><i class="fas fa-address-book"></i> Danh sách người dùng</h3>
                    <button class="btn-outline" onclick="app.router('teacher')">Quay lại</button>
                </div>
                <div class="table-responsive">
                    <table id="user-table">
                        <thead>
                            <tr><th>Tên đăng nhập</th><th>Họ tên</th><th>Email</th><th>SĐT</th><th>Vai trò</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. CREATE QUIZ -->
        <div id="view-create-quiz" class="hidden">
            <div class="card">
                <div class="flex-between" style="padding-bottom:15px; border-bottom:1px solid var(--border); margin-bottom:20px">
                    <h3><i class="fas fa-edit"></i> Soạn thảo đề thi</h3>
                    <button class="btn-outline" onclick="teacher.cancelEdit()">Hủy bỏ</button>
                </div>
                
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px">
                    <input type="text" id="q-title" placeholder="Tiêu đề bài thi (VD: Kiểm tra 15 phút)">
                    <input type="number" id="q-time" placeholder="Phút" value="45">
                    <input type="text" id="q-pass" placeholder="Mật khẩu (Để trống = Công khai)">
                </div>

                <div id="editor-container"></div>
                
                <button class="btn-outline" style="width:100%; margin:20px 0; border-style:dashed" onclick="teacher.addUI()">
                    <i class="fas fa-plus"></i> Thêm câu hỏi
                </button>

                <div class="flex-between">
                    <div></div>
                    <button class="btn-primary" style="padding:12px 30px" onclick="teacher.save()">LƯU ĐỀ THI</button>
                </div>
            </div>
        </div>

        <!-- 4. STUDENT DASHBOARD -->
        <div id="view-student" class="hidden">
            <div style="display:grid; grid-template-columns: 1fr 2.5fr; gap:20px; align-items:start">
                
                <!-- Profile Card -->
                <div class="card" style="text-align:center">
                    <div style="width:100px; height:100px; border-radius:50%; background:linear-gradient(to right, var(--primary), var(--secondary)); margin:0 auto 15px; display:flex; align-items:center; justify-content:center; color:white; font-size:2.5rem; font-weight:bold">
                        <i class="fas fa-user-astronaut"></i>
                    </div>
                    <h3 id="profile-name" style="margin:0 0 5px">User</h3>
                    <p id="profile-role" style="color:var(--primary); font-weight:bold; font-size:0.9rem">STUDENT</p>
                    
                    <div style="text-align:left; margin-top:20px; font-size:0.9rem">
                        <p><i class="fas fa-envelope" style="width:20px; color:var(--text-sub)"></i> <span id="profile-email">---</span></p>
                        <p><i class="fas fa-phone" style="width:20px; color:var(--text-sub)"></i> <span id="profile-phone">---</span></p>
                        <p><i class="fas fa-star" style="width:20px; color:var(--warning)"></i> Điểm TB: <span id="profile-avg" style="font-weight:bold">0.0</span></p>
                    </div>

                    <button class="btn-outline" style="width:100%; margin-top:15px" onclick="student.renderHistory()">
                        <i class="fas fa-history"></i> Xem lịch sử thi
                    </button>
                    <button class="btn-outline" style="width:100%; margin-top:10px" onclick="app.upgradeTeacher()">
                        <i class="fas fa-chalkboard-teacher"></i> Nâng cấp GV
                    </button>
                </div>

                <!-- Quiz List -->
                <div>
                    <div class="card flex-between" style="padding:15px">
                        <h3 style="margin:0"><i class="fas fa-book-reader"></i> Đề thi hiện có</h3>
                        <div class="flex-gap">
                            <i class="fas fa-search" style="color:var(--text-sub)"></i>
                            <input type="text" id="s-search" placeholder="Tìm đề thi..." onkeyup="student.renderDashboard()" style="border:none; background:transparent; width:200px">
                        </div>
                    </div>
                    <div id="student-list" class="quiz-grid"></div>
                </div>
            </div>
        </div>

        <!-- 5. WAITING ROOM -->
        <div id="view-pre-quiz" class="hidden">
            <div class="card" style="max-width:550px; margin:40px auto; text-align:center">
                <i class="fas fa-rocket" style="font-size:4rem; color:var(--secondary); margin-bottom:20px"></i>
                <h2 id="pre-title" style="margin:0 0 10px">Tiêu đề</h2>
                <div style="background:var(--bg-body); padding:20px; border-radius:12px; margin:20px 0; text-align:left">
                    <div class="flex-between">
                        <span><i class="fas fa-user-tie"></i> Giáo viên:</span>
                        <b id="pre-author"></b>
                    </div>
                    <hr style="border:0; border-top:1px dashed var(--border); margin:10px 0">
                    <div class="flex-between">
                        <span><i class="fas fa-clock"></i> Thời gian:</span>
                        <b><span id="pre-time"></span> phút</b>
                    </div>
                    <div class="flex-between" style="margin-top:10px">
                        <span><i class="fas fa-question-circle"></i> Số câu hỏi:</span>
                        <b><span id="pre-len"></span> câu</b>
                    </div>
                </div>
                
                <div id="pass-area" class="hidden" style="margin-bottom:20px">
                    <input type="password" id="exam-pass" placeholder="Nhập mật khẩu đề thi..." style="text-align:center; border:2px solid var(--primary)">
                </div>

                <div class="flex-gap">
                    <button class="btn-outline" style="flex:1" onclick="app.goHome()">Quay lại</button>
                    <button class="btn-primary" style="flex:2" onclick="student.checkStart()">BẮT ĐẦU NGAY</button>
                </div>
            </div>
        </div>

        <!-- 6. DOING QUIZ -->
        <div id="view-taking" class="hidden">
            <div class="flex-between" style="background:var(--bg-card); padding:15px 25px; position:sticky; top:80px; z-index:90; box-shadow:var(--shadow); border-radius:var(--radius); margin-bottom:20px">
                <div style="font-weight:bold; font-size:1.1rem; color:var(--primary)"><i class="fas fa-pencil-alt"></i> <span id="taking-title"></span></div>
                <div id="timer-box">00:00</div>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
                <div id="quiz-body"></div>
                <div style="text-align:center; margin-top:40px; margin-bottom: 50px;">
                    <button class="btn-primary" onclick="student.submit(false)" style="padding:16px 60px; font-size:1.2rem; border-radius: 30px; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);">
                        <i class="fas fa-paper-plane"></i> NỘP BÀI HOÀN TẤT
                    </button>
                </div>
            </div>
        </div>

        <!-- 7. RESULT -->
        <div id="view-result" class="hidden">
            <div class="card" style="text-align:center; max-width:650px; margin:30px auto">
                <i class="fas fa-trophy" style="font-size:3rem; color:#fbbf24; margin-bottom:15px"></i>
                <h2 style="margin:0">Kết Quả Bài Thi</h2>
                
                <div style="display:flex; justify-content:center; gap:20px; margin:30px 0">
                    <div style="text-align:center">
                        <div style="font-size:2.5rem; font-weight:800; color:var(--primary)" id="res-score">0</div>
                        <div style="color:var(--text-sub); font-size:0.9rem">Điểm số</div>
                    </div>
                    <div style="border-right:1px solid var(--border)"></div>
                    <div style="text-align:center">
                        <div style="font-size:2.5rem; font-weight:800; color:var(--success)" id="res-right">0</div>
                        <div style="color:var(--text-sub); font-size:0.9rem">Số câu đúng</div>
                    </div>
                    <div style="border-right:1px solid var(--border)"></div>
                    <div style="text-align:center">
                        <div style="font-size:2.5rem; font-weight:800; color:var(--warning)" id="res-time">00:00</div>
                        <div style="color:var(--text-sub); font-size:0.9rem">Thời gian</div>
                    </div>
                </div>

                <div class="flex-gap" style="justify-content:center">
                    <button class="btn-outline" onclick="student.toggleReview()">Xem lại đáp án</button>
                    <button class="btn-primary" onclick="app.goHome()">Về trang chủ</button>
                </div>
            </div>
            
            <div id="review-area" class="hidden card">
                <div class="flex-between" style="margin-bottom:20px">
                    <h3>Chi tiết bài làm</h3>
                    <div class="flex-gap">
                        <input type="checkbox" id="filter-wrong" onchange="student.filterReview()" style="width:auto; margin:0">
                        <label for="filter-wrong">Chỉ hiện câu sai</label>
                    </div>
                </div>
                <div id="review-content"></div>
            </div>
        </div>

        <!-- 8. REPORT (TEACHER VIEW) -->
        <div id="view-report" class="hidden">
            <div class="card">
                <div class="flex-between">
                    <h3 id="rp-title">Bảng xếp hạng</h3>
                    <button class="btn-outline" onclick="app.router('teacher')">Quay lại</button>
                </div>
                <div class="table-responsive">
                    <table id="rp-table">
                        <thead>
                            <tr><th>Hạng</th><th>Học sinh</th><th>Email</th><th>Điểm số</th><th>Thời gian</th><th>Ngày nộp</th></tr>
                        </thead>
                        <tbody id="rp-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 9. HISTORY (STUDENT VIEW) -->
        <div id="view-history" class="hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:20px">
                    <h3><i class="fas fa-history"></i> Lịch sử làm bài</h3>
                    <button class="btn-outline" onclick="app.goHome()">Quay lại</button>
                </div>
                <div class="table-responsive">
                    <table id="his-table">
                        <thead>
                            <tr><th>Tên đề thi</th><th>Giáo viên</th><th>Điểm số</th><th>Thời gian làm</th><th>Ngày nộp</th><th>Trạng thái</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);

        // --- UTILS ---
        const notify = (msg, type='info') => {
            const icons = { info: 'fa-info-circle', success: 'fa-check-circle', error: 'fa-times-circle', warning: 'fa-exclamation-triangle' };
            const colors = { info: 'var(--primary)', success: 'var(--success)', error: 'var(--danger)', warning: 'var(--warning)' };
            
            const div = document.createElement('div');
            div.className = 'toast';
            div.style.borderLeftColor = colors[type];
            div.innerHTML = `<i class="fas ${icons[type]}" style="color:${colors[type]}; font-size:1.2rem"></i> <div>${msg}</div>`;
            
            $('#toast-container').appendChild(div);
            setTimeout(() => { 
                div.style.transform = 'translateX(120%)'; 
                setTimeout(()=>div.remove(), 300);
            }, 3000);
        };

        const DB = {
            users: JSON.parse(localStorage.getItem('edu_users') || '[]'),
            quizzes: JSON.parse(localStorage.getItem('edu_quizzes') || '[]'),
            results: JSON.parse(localStorage.getItem('edu_results') || '[]'),
            save: () => {
                localStorage.setItem('edu_users', JSON.stringify(DB.users));
                localStorage.setItem('edu_quizzes', JSON.stringify(DB.quizzes));
                localStorage.setItem('edu_results', JSON.stringify(DB.results));
            }
        };

        // --- OTP SERVICE (MOCK) ---
        const otpService = {
            code: null,
            target: null, // Email or Phone
            type: null, // 'REGISTER' or 'RESET'
            tempData: null, // Store reg data
            generate: () => Math.floor(100000 + Math.random() * 900000).toString(),
            send: (contact, msg) => {
                const code = otpService.generate();
                otpService.code = code;
                otpService.target = contact;
                // SIMULATE SENDING SMS/EMAIL
                setTimeout(() => {
                    alert(`[EDU PRO OTP SYSTEM]\n\n${msg}\nMã xác thực của bạn là: ${code}`);
                }, 500);
            },
            verify: (input) => input === otpService.code
        };

        // --- AUTH ---
        const auth = {
            user: null,
            switch: (type) => {
                $('#form-login').classList.toggle('hidden', type !== 'login');
                $('#form-register').classList.toggle('hidden', type !== 'register');
                $$('input').forEach(i => i.value = ''); 
            },
            login: () => {
                const u = $('#l-user').value.trim();
                const p = $('#l-pass').value.trim();
                if(!u || !p) return notify('Vui lòng nhập đủ thông tin', 'error');

                const acc = DB.users.find(x => x.username === u && x.password === p);
                if(acc) {
                    auth.user = acc;
                    app.init();
                    notify('Đăng nhập thành công', 'success');
                } else notify('Sai tài khoản hoặc mật khẩu', 'error');
            },
            preRegister: () => {
                const name = $('#r-name').value.trim();
                const u = $('#r-user').value.trim();
                const email = $('#r-email').value.trim();
                const phone = $('#r-phone').value.trim();
                const p = $('#r-pass').value.trim();

                if(!name || !u || !p || !email || !phone) return notify('Vui lòng điền tất cả các trường', 'error');
                if(/\s/.test(u)) return notify('Tên đăng nhập không được có khoảng trắng', 'error');
                if(!/^\S+@\S+\.\S+$/.test(email)) return notify('Email không hợp lệ', 'error');
                if(!/^\d{10,11}$/.test(phone)) return notify('Số điện thoại phải là 10-11 số', 'error');

                const passRegex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).+$/;
                if (!passRegex.test(p)) return notify('Mật khẩu phải chứa 1 chữ Hoa và 1 ký tự đặc biệt', 'error');
                
                if(DB.users.find(x => x.username === u)) return notify('Tên đăng nhập đã tồn tại', 'error');
                if(DB.users.find(x => x.email === email)) return notify('Email này đã được sử dụng', 'error');

                // Store data temporarily and send OTP
                otpService.tempData = { username: u, password: p, fullname: name, email: email, phone: phone, role: 'student', joined: new Date().toISOString() };
                otpService.type = 'REGISTER';
                
                $('#otp-mode-reset').classList.add('hidden');
                $('#modal-otp').classList.remove('hidden');
                $('#otp-input').value = '';
                otpService.send(email, `Xác thực đăng ký tài khoản cho ${u}`);
            },
            forgotPass: () => {
                const u = prompt("Nhập Tên đăng nhập hoặc Email của bạn để lấy lại mật khẩu:");
                if(!u) return;
                
                const acc = DB.users.find(x => x.username === u || x.email === u);
                if(!acc) return notify("Không tìm thấy tài khoản này trong hệ thống.", "error");

                otpService.tempData = acc; // Store user ref
                otpService.type = 'RESET';

                $('#otp-mode-reset').classList.remove('hidden');
                $('#modal-otp').classList.remove('hidden');
                $('#otp-input').value = '';
                $('#new-password-input').value = '';
                otpService.send(acc.email, `Yêu cầu đặt lại mật khẩu cho tài khoản ${acc.username}`);
            },
            submitOTP: () => {
                const input = $('#otp-input').value.trim();
                if(!otpService.verify(input)) return notify("Mã OTP không chính xác!", "error");

                if(otpService.type === 'REGISTER') {
                    DB.users.push(otpService.tempData);
                    DB.save();
                    notify('Đăng ký thành công! Hãy đăng nhập.', 'success');
                    $('#modal-otp').classList.add('hidden');
                    auth.switch('login');
                } else if (otpService.type === 'RESET') {
                    const newPass = $('#new-password-input').value.trim();
                    const passRegex = /^(?=.*[A-Z])(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).+$/;
                    if (!passRegex.test(newPass)) return notify('Mật khẩu mới phải chứa 1 chữ Hoa và 1 ký tự đặc biệt', 'error');

                    const idx = DB.users.findIndex(u => u.username === otpService.tempData.username);
                    if(idx !== -1) {
                        DB.users[idx].password = newPass;
                        DB.save();
                        notify("Đổi mật khẩu thành công!", "success");
                        $('#modal-otp').classList.add('hidden');
                    }
                }
            },
            logout: () => location.reload()
        };

        // --- TEACHER ---
        const teacher = {
            editId: null,
            renderDashboard: () => {
                const myQuizzes = DB.quizzes.filter(q => q.author === auth.user.username);
                const myResults = DB.results.filter(r => myQuizzes.some(q => q.id === r.quizId));
                
                $('#stat-quizzes').innerText = myQuizzes.length;
                $('#stat-students').innerText = DB.users.filter(u => u.role === 'student').length;
                $('#stat-attempts').innerText = myResults.length;

                teacher.renderList();
            },
            renderList: () => {
                const keyword = $('#t-search').value.toLowerCase();
                const myQuizzes = DB.quizzes.filter(q => q.author === auth.user.username);
                const filtered = myQuizzes.filter(q => q.title.toLowerCase().includes(keyword));

                $('#teacher-list').innerHTML = filtered.map(q => `
                    <div class="quiz-item">
                        <span class="quiz-tag">${q.questions.length} câu</span>
                        <div style="font-weight:bold; font-size:1.1rem; margin-right:40px">${q.title}</div>
                        <div style="color:var(--text-sub); font-size:0.9rem; margin:8px 0 15px">
                            <i class="fas fa-clock"></i> ${q.time} phút • Mã: ${q.password ? 'Có' : 'Không'}
                        </div>
                        <div class="flex-gap">
                            <button class="btn-outline btn-icon" onclick="teacher.report(${q.id})" title="Kết quả"><i class="fas fa-chart-pie"></i></button>
                            <button class="btn-outline btn-icon" onclick="teacher.edit(${q.id})" title="Sửa"><i class="fas fa-pen"></i></button>
                            <button class="btn-danger btn-icon" onclick="teacher.del(${q.id})" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                `).join('') || '<div style="grid-column:1/-1; text-align:center; padding:20px; color:var(--text-sub)">Không tìm thấy đề thi nào.</div>';
            },
            showUsers: () => {
                const students = DB.users;
                $('#user-table tbody').innerHTML = students.map(u => `
                    <tr>
                        <td style="font-weight:bold">${u.username}</td>
                        <td>${u.fullname}</td>
                        <td>${u.email}</td>
                        <td>${u.phone}</td>
                        <td><span style="padding:4px 8px; border-radius:4px; font-size:0.8rem; background:${u.role==='teacher'?'var(--primary)':'#e2e8f0'}; color:${u.role==='teacher'?'white':'inherit'}">${u.role.toUpperCase()}</span></td>
                    </tr>
                `).join('');
                app.router('users');
            },
            addUI: (data = null) => {
                const div = document.createElement('div');
                div.className = 'question-card editor-block';
                div.innerHTML = `
                    <div class="flex-between" style="margin-bottom:10px">
                        <select class="q-type" onchange="teacher.changeType(this)" style="width:auto">
                            <option value="mc" ${data?.type==='mc'?'selected':''}>Trắc nghiệm</option>
                            <option value="tf" ${data?.type==='tf'?'selected':''}>Đúng/Sai</option>
                            <option value="sa" ${data?.type==='sa'?'selected':''}>Điền từ</option>
                        </select>
                        <button class="btn-danger btn-icon" onclick="this.closest('.editor-block').remove()" style="width:30px;height:30px"><i class="fas fa-times"></i></button>
                    </div>
                    <textarea class="q-text" rows="2" placeholder="Nội dung câu hỏi...">${data?.q||''}</textarea>
                    <textarea class="q-explain" rows="1" placeholder="Giải thích đáp án (tùy chọn)..." style="font-size:0.9rem; border-color:var(--success)">${data?.explain||''}</textarea>
                    <div class="q-content" style="margin-top:10px"></div>
                `;
                $('#editor-container').appendChild(div);
                teacher.changeType(div.querySelector('.q-type'), data);
            },
            changeType: (el, data) => {
                const content = el.closest('.editor-block').querySelector('.q-content');
                const type = el.value;
                if(type === 'mc') {
                    content.innerHTML = `
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                            <div class="input-group" style="margin:0"><i class="fas fa-check" style="color:var(--success)"></i><input value="${data?.opts?.[0]||''}" class="opt-c" placeholder="Đáp án ĐÚNG"></div>
                            <div class="input-group" style="margin:0"><i class="fas fa-times" style="color:var(--danger)"></i><input value="${data?.opts?.[1]||''}" class="opt" placeholder="Sai 1"></div>
                            <div class="input-group" style="margin:0"><i class="fas fa-times" style="color:var(--danger)"></i><input value="${data?.opts?.[2]||''}" class="opt" placeholder="Sai 2"></div>
                            <div class="input-group" style="margin:0"><i class="fas fa-times" style="color:var(--danger)"></i><input value="${data?.opts?.[3]||''}" class="opt" placeholder="Sai 3"></div>
                        </div>`;
                } else if(type === 'tf') {
                    content.innerHTML = `
                        <select class="tf-val">
                            <option value="true" ${data?.correct==='true'?'selected':''}>Đáp án: ĐÚNG</option>
                            <option value="false" ${data?.correct==='false'?'selected':''}>Đáp án: SAI</option>
                        </select>`;
                } else {
                    content.innerHTML = `<input class="sa-val" placeholder="Nhập đáp án chính xác (không phân biệt hoa thường)" value="${data?.correct||''}">`;
                }
            },
            save: () => {
                const title = $('#q-title').value;
                const blocks = $$('.editor-block');
                if(!title || blocks.length === 0) return notify("Cần tên đề và ít nhất 1 câu hỏi", 'error');
                
                const questions = Array.from(blocks).map(b => {
                    const type = b.querySelector('.q-type').value;
                    const q = b.querySelector('.q-text').value;
                    const explain = b.querySelector('.q-explain').value;
                    let res = { type, q, explain, opts: [], correct: null };
                    
                    if(type==='mc') {
                        res.opts = [
                            b.querySelector('.opt-c').value,
                            ...Array.from(b.querySelectorAll('.opt')).map(i=>i.value)
                        ];
                        res.correct = 0; 
                    } else if (type==='tf') res.correct = b.querySelector('.tf-val').value;
                    else res.correct = b.querySelector('.sa-val').value;
                    return res;
                });

                const quiz = {
                    id: teacher.editId || Date.now(),
                    title,
                    time: parseInt($('#q-time').value)||45,
                    password: $('#q-pass').value,
                    author: auth.user.username,
                    questions,
                    created: new Date().toISOString()
                };

                if(teacher.editId) {
                    const idx = DB.quizzes.findIndex(q => q.id === teacher.editId);
                    DB.quizzes[idx] = quiz;
                } else DB.quizzes.push(quiz);
                
                DB.save();
                notify("Lưu đề thi thành công!", "success");
                teacher.cancelEdit();
            },
            edit: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                teacher.editId = id;
                $('#q-title').value = q.title;
                $('#q-time').value = q.time;
                $('#q-pass').value = q.password;
                $('#editor-container').innerHTML = '';
                q.questions.forEach(qs => teacher.addUI(qs));
                app.router('create-quiz');
            },
            del: (id) => {
                if(confirm("Xóa đề thi này?")) {
                    DB.quizzes = DB.quizzes.filter(q => q.id !== id);
                    DB.save();
                    teacher.renderDashboard();
                }
            },
            cancelEdit: () => {
                teacher.editId = null;
                app.router('teacher');
            },
            report: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                $('#rp-title').innerText = `Kết quả: ${q.title}`;
                
                const data = DB.results.filter(r => r.quizId === id).sort((a,b) => b.score - a.score || a.timeSec - b.timeSec);
                
                const getEmail = (uName) => {
                    const u = DB.users.find(x => x.username === uName);
                    return u ? u.email : '---';
                };

                $('#rp-body').innerHTML = data.map((r, i) => `
                    <tr>
                        <td><span style="display:inline-block; width:25px; height:25px; background:${i<3?'var(--warning)':'#ccc'}; color:white; border-radius:50%; text-align:center; line-height:25px; font-weight:bold">${i+1}</span></td>
                        <td>${r.fullname}</td>
                        <td style="color:var(--text-sub); font-size:0.9rem">${getEmail(r.username)}</td>
                        <td style="font-weight:bold; color:var(--primary)">${r.score}</td>
                        <td>${r.timeString}</td>
                        <td>${new Date(r.timestamp).toLocaleDateString()}</td>
                    </tr>
                `).join('') || '<tr><td colspan="6" style="text-align:center; padding:20px">Chưa có ai làm bài này.</td></tr>';
                app.router('report');
            }
        };

        // --- STUDENT ---
        const student = {
            quiz: null,
            questions: [],
            timer: null,
            timeLeft: 0,
            reviewData: [],

            renderDashboard: () => {
                // Render Profile Info
                $('#profile-name').innerText = auth.user.fullname;
                $('#profile-email').innerText = auth.user.email || 'Chưa cập nhật';
                $('#profile-phone').innerText = auth.user.phone || 'Chưa cập nhật';
                $('#profile-role').innerText = auth.user.role === 'teacher' ? 'GIÁO VIÊN' : 'HỌC SINH';

                const myRes = DB.results.filter(r => r.username === auth.user.username);
                const avg = myRes.length ? (myRes.reduce((a,b)=>a+b.score,0)/myRes.length).toFixed(2) : '0.0';
                $('#profile-avg').innerText = avg;

                // Render List with Search
                const keyword = $('#s-search').value.toLowerCase();
                const filtered = DB.quizzes.filter(q => q.title.toLowerCase().includes(keyword) || q.author.toLowerCase().includes(keyword));

                $('#student-list').innerHTML = filtered.map(q => `
                    <div class="quiz-item" onclick="student.openStart(${q.id})">
                        <span class="quiz-tag">${q.questions.length} Câu</span>
                        <div style="font-weight:bold; font-size:1.1rem; color:var(--primary); margin-bottom:5px">${q.title}</div>
                        <div style="font-size:0.85rem; color:var(--text-sub)">
                            <i class="fas fa-user-circle"></i> GV: ${q.author}
                        </div>
                        <div style="font-size:0.85rem; color:var(--text-sub); margin-top:5px">
                            ${q.password ? '<span style="color:var(--danger)"><i class="fas fa-lock"></i> Cần mật khẩu</span>' : '<span style="color:var(--success)"><i class="fas fa-lock-open"></i> Miễn phí</span>'}
                        </div>
                    </div>
                `).join('') || '<div style="color:var(--text-sub)">Không tìm thấy đề thi.</div>';
            },
            renderHistory: () => {
                const history = DB.results.filter(r => r.username === auth.user.username).reverse();
                
                $('#his-table tbody').innerHTML = history.map(h => {
                    const quiz = DB.quizzes.find(q => q.id === h.quizId);
                    const title = quiz ? quiz.title : '<span style="color:var(--text-sub)">Đề thi đã bị xóa</span>';
                    const author = quiz ? quiz.author : '---';
                    return `
                    <tr>
                        <td style="font-weight:bold">${title}</td>
                        <td>${author}</td>
                        <td><span style="font-weight:bold; color:${h.score >= 5 ? 'var(--success)' : 'var(--danger)'}">${h.score}</span></td>
                        <td>${h.timeString}</td>
                        <td>${new Date(h.timestamp).toLocaleString()}</td>
                        <td><span style="padding:2px 8px; border-radius:4px; font-size:0.8rem; background:#dcfce7; color:var(--success)">Hoàn thành</span></td>
                    </tr>
                    `;
                }).join('') || '<tr><td colspan="6" style="text-align:center; padding:20px">Bạn chưa làm bài thi nào.</td></tr>';
                
                app.router('history');
            },
            openStart: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                student.quiz = q;
                $('#pre-title').innerText = q.title;
                $('#pre-author').innerText = q.author;
                $('#pre-time').innerText = q.time;
                $('#pre-len').innerText = q.questions.length;
                $('#pass-area').classList.toggle('hidden', !q.password);
                $('#exam-pass').value = '';
                app.router('pre-quiz');
            },
            checkStart: () => {
                if(student.quiz.password && $('#exam-pass').value !== student.quiz.password) return notify('Mật khẩu đề thi không đúng', 'error');
                
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().then(student.start).catch(() => student.start());
                } else student.start();
            },
            start: () => {
                app.router('taking');
                $('#taking-title').innerText = student.quiz.title;
                student.timeLeft = student.quiz.time * 60;
                
                // Shuffle options for MC
                student.questions = student.quiz.questions.map(q => {
                    if(q.type === 'mc') {
                        let idxs = [0,1,2,3].sort(()=>Math.random()-0.5);
                        return { ...q, optsDisplay: idxs.map(i => q.opts[i]), trueIdx: idxs.indexOf(0) };
                    }
                    return q;
                });
                
                $('#quiz-body').innerHTML = student.questions.map((q, i) => `
                    <div class="question-card" id="q-card-${i}">
                        <div class="q-header">
                            <span class="q-badge">Câu ${i+1}</span>
                            <span>${q.q}</span>
                        </div>
                        <div class="q-options">${student.renderInput(q, i)}</div>
                    </div>
                `).join('');

                if(student.timer) clearInterval(student.timer);
                student.timer = setInterval(() => {
                    student.timeLeft--;
                    const m = Math.floor(student.timeLeft/60).toString().padStart(2,'0');
                    const s = (student.timeLeft%60).toString().padStart(2,'0');
                    $('#timer-box').innerText = `${m}:${s}`;
                    if(student.timeLeft<=0) student.submit(true);
                }, 1000);
            },
            renderInput: (q, idx) => {
                if(q.type === 'mc') {
                    return q.optsDisplay.map((opt, i) => `
                        <label class="opt-row" onclick="student.selectOpt(${idx}, this)">
                            <input type="radio" name="answ-${idx}" value="${i}">
                            <span class="opt-text">${opt}</span>
                        </label>`).join('');
                } else if (q.type === 'tf') {
                    return `
                        <label class="opt-row" onclick="student.selectOpt(${idx}, this)">
                            <input type="radio" name="answ-${idx}" value="true"> 
                            <span class="opt-text">ĐÚNG (True)</span>
                        </label>
                        <label class="opt-row" onclick="student.selectOpt(${idx}, this)">
                            <input type="radio" name="answ-${idx}" value="false"> 
                            <span class="opt-text">SAI (False)</span>
                        </label>
                    `;
                } else {
                    return `<input type="text" name="answ-${idx}" placeholder="Nhập câu trả lời của bạn..." class="sa-input">`;
                }
            },
            selectOpt: (idx, el) => {
                const container = el.parentElement;
                container.querySelectorAll('.opt-row').forEach(row => row.classList.remove('selected'));
                el.classList.add('selected');
                const rad = el.querySelector('input[type="radio"]');
                if(rad) rad.checked = true;
            },
            submit: (auto) => {
                if(!auto && !confirm("Bạn chắc chắn muốn nộp bài?")) return;
                clearInterval(student.timer);
                if(document.fullscreenElement) document.exitFullscreen();

                let correct = 0;
                student.reviewData = student.questions.map((q, i) => {
                    let isRight = false, uVal = '', rVal = '';
                    
                    if(q.type === 'mc') {
                        const el = $(`input[name="answ-${i}"]:checked`);
                        const val = el ? parseInt(el.value) : -1;
                        uVal = val !== -1 ? q.optsDisplay[val] : '---';
                        rVal = q.optsDisplay[q.trueIdx];
                        if(val === q.trueIdx) isRight = true;
                    } else if (q.type === 'tf') {
                        const el = $(`input[name="answ-${i}"]:checked`);
                        uVal = el ? (el.value==='true'?'Đúng':'Sai') : '---';
                        rVal = q.correct==='true'?'Đúng':'Sai';
                        if(el && el.value === q.correct) isRight = true;
                    } else {
                        const el = $(`input[name="answ-${i}"]`);
                        uVal = el.value.trim();
                        rVal = q.correct;
                        if(uVal.toLowerCase() === rVal.toLowerCase()) isRight = true;
                        if(!uVal) uVal = '---';
                    }
                    if(isRight) correct++;
                    return { q: q.q, u: uVal, r: rVal, right: isRight, explain: q.explain };
                });

                const score = ((correct / student.questions.length) * 10).toFixed(2);
                const timeTaken = (student.quiz.time * 60) - student.timeLeft;
                const m = Math.floor(timeTaken/60), s = timeTaken%60;
                const timeStr = `${m}p ${s}s`;

                DB.results.push({
                    id: Date.now(),
                    quizId: student.quiz.id,
                    username: auth.user.username,
                    fullname: auth.user.fullname,
                    score: parseFloat(score),
                    timeSec: timeTaken,
                    timeString: timeStr,
                    timestamp: Date.now()
                });
                DB.save();

                $('#res-score').innerText = score;
                $('#res-right').innerText = `${correct}/${student.questions.length}`;
                $('#res-time').innerText = timeStr;
                
                student.renderReviewUI(student.reviewData);
                app.router('result');
            },
            toggleReview: () => $('#review-area').classList.toggle('hidden'),
            filterReview: () => {
                const onlyWrong = $('#filter-wrong').checked;
                const data = onlyWrong ? student.reviewData.filter(x => !x.right) : student.reviewData;
                student.renderReviewUI(data);
            },
            renderReviewUI: (data) => {
                $('#review-content').innerHTML = data.map((item) => `
                    <div style="padding:15px; border-left:4px solid ${item.right?'var(--success)':'var(--danger)'}; border-radius:4px; margin-bottom:15px; background:${item.right?'rgba(16,185,129,0.05)':'rgba(239,68,68,0.05)'}; box-shadow:0 1px 2px rgba(0,0,0,0.05)">
                        <div style="font-weight:bold; margin-bottom:8px">${item.q}</div>
                        <div style="font-size:0.9rem; display:flex; gap:15px; flex-wrap:wrap">
                            <span style="color:${item.right?'var(--success)':'var(--danger)'}; font-weight:bold">${item.right?'<i class="fas fa-check"></i> ĐÚNG':'<i class="fas fa-times"></i> SAI'}</span>
                            <span>Bạn chọn: <b>${item.u}</b></span>
                        </div>
                        ${!item.right ? `<div style="color:var(--success); font-size:0.9rem; margin-top:5px"><i class="fas fa-key"></i> Đáp án đúng: <b>${item.r}</b></div>` : ''}
                        ${item.explain ? `<div style="margin-top:8px; font-style:italic; color:var(--text-sub); border-top:1px dashed #e2e8f0; padding-top:8px"><i class="fas fa-lightbulb" style="color:#fbbf24"></i> ${item.explain}</div>` : ''}
                    </div>
                `).join('') || '<p style="text-align:center; color:var(--text-sub)">Không có dữ liệu hiển thị.</p>';
            },
            viewHistory: () => {
                alert("Tính năng đang phát triển.");
            }
        };

        const dataMgr = {
            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localStorage));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "edupro_backup.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            },
            importData: (input) => {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.clear();
                        Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                        alert("Khôi phục thành công!");
                        location.reload();
                    } catch(err) { notify("File lỗi!", "error"); }
                };
                reader.readAsText(file);
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            init: () => {
                if(!auth.user) return app.router('auth');
                $('#user-area').innerHTML = `
                    <div style="text-align:right">
                        <div style="font-weight:bold; color:var(--primary)">${auth.user.fullname}</div>
                        <div style="font-size:0.8rem; color:var(--text-sub); cursor:pointer" onclick="auth.logout()">Đăng xuất <i class="fas fa-sign-out-alt"></i></div>
                    </div>
                `;
                auth.user.role === 'teacher' ? app.router('teacher') : app.router('student');
            },
            router: (view) => {
                $$('.container > div').forEach(el => el.classList.add('hidden'));
                const target = $(`#view-${view}`);
                if(target) target.classList.remove('hidden');
                
                if(view === 'teacher') teacher.renderDashboard();
                if(view === 'student') student.renderDashboard();
                window.scrollTo(0,0);
            },
            toggleTheme: () => {
                document.body.classList.toggle('dark-mode');
            },
            goHome: () => {
                if(!auth.user) app.router('auth');
                else auth.user.role === 'teacher' ? app.router('teacher') : app.router('student');
            },
            upgradeTeacher: () => {
                if(confirm("Nâng cấp lên tài khoản Giáo viên để tạo đề thi?")) {
                    auth.user.role = 'teacher';
                    const idx = DB.users.findIndex(u => u.username === auth.user.username);
                    DB.users[idx].role = 'teacher';
                    DB.save();
                    location.reload();
                }
            }
        };

        app.init();
    </script>
</body>
</html>
