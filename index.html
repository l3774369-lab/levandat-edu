<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPro VIP ONLINE - Version 3.0 (Cloud Sync)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #db2777;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --border: #cbd5e1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius: 12px;
        }

        .dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --border: #334155;
            --primary-light: rgba(79, 70, 229, 0.2);
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 50px; font-size: 16px; line-height: 1.5; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); }
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .flex-gap { display: flex; gap: 10px; align-items: center; }
        
        /* HEADER */
        .header { background: var(--bg-card); padding: 15px 30px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .brand { font-size: 1.6rem; font-weight: 800; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; cursor: pointer; }
        
        /* BUTTONS & INPUTS */
        button { cursor: pointer; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.4); }
        .btn-primary:hover { opacity: 0.9; box-shadow: 0 6px 20px rgba(79, 70, 229, 0.23); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 40px; height: 40px; }

        .input-group { position: relative; margin-bottom: 15px; }
        .input-group i { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: var(--text-sub); }
        .input-group input { padding-left: 40px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

        /* DASHBOARD */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }
        
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .quiz-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }
        .quiz-item:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .quiz-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: var(--primary-light); color: var(--primary); font-weight: bold; }

        /* TABLE */
        .table-responsive { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 14px 20px; text-align: left; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        th { color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; background: var(--bg-body); }
        tr:last-child td { border-bottom: none; }
        
        /* TOAST */
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); display: flex; align-items: center; gap: 10px; min-width: 300px; animation: slideIn 0.3s ease-out; color: var(--text-main); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* EXAM STYLES */
        .question-card { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border); border-radius: 16px; background: var(--bg-card); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .q-header { font-weight: 700; font-size: 1.1rem; margin-bottom: 20px; color: var(--text-main); line-height: 1.6; }
        .q-badge { background: var(--primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; margin-right: 10px; }
        .opt-row { display: flex; align-items: center; padding: 15px 20px; border: 2px solid var(--border); border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; position: relative; background: var(--bg-body); }
        .opt-row:hover { border-color: #a5b4fc; background: #fff; }
        .opt-row.selected { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 1px var(--primary); }
        .opt-row input[type="radio"] { width: 20px; height: 20px; margin: 0 15px 0 0; accent-color: var(--primary); cursor: pointer; }
        .opt-text { font-size: 1rem; color: var(--text-main); user-select: none; flex: 1; }
        .sa-input { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid var(--border); border-radius: 10px; background: var(--bg-body); }
        .sa-input:focus { border-color: var(--primary); background: #fff; }
        #timer-box { font-variant-numeric: tabular-nums; font-weight: 800; font-size: 1.4rem; color: var(--danger); background: rgba(239, 68, 68, 0.1); padding: 8px 20px; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2); }

        /* LOADING */
        #view-loading { position: fixed; inset: 0; background: var(--bg-body); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 5px solid var(--border); border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* MODAL (OTP) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius); width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; border: 1px solid var(--border); }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    
    <!-- LOADING SCREEN -->
    <div id="view-loading">
        <div class="loader"></div>
        <h3 style="color:var(--primary)">Đang đồng bộ dữ liệu...</h3>
        <p>Vui lòng đợi trong giây lát</p>
    </div>

    <!-- MODAL OTP -->
    <div id="modal-otp" class="modal-overlay hidden">
        <div class="modal-card">
            <i class="fas fa-shield-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
            <h3>Xác thực OTP</h3>
            <p style="color: var(--text-sub); font-size: 0.9rem; margin-bottom: 20px;">
                Mã xác thực đã được gửi đến thiết bị của bạn.<br>(Check thông báo trình duyệt)
            </p>
            <div id="otp-mode-reset" class="hidden" style="margin-bottom: 15px;">
                <input type="password" id="new-password-input" placeholder="Nhập mật khẩu mới">
            </div>
            <input type="text" id="otp-input" placeholder="Nhập mã 6 số (VD: 123456)" style="text-align: center; font-size: 1.2rem; letter-spacing: 2px; font-weight: bold; margin-bottom: 20px;">
            <button class="btn-primary" style="width: 100%;" onclick="auth.submitOTP()">XÁC NHẬN</button>
            <button class="btn-outline" style="width: 100%; margin-top: 10px;" onclick="$('#modal-otp').classList.add('hidden')">Hủy bỏ</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="brand" onclick="app.goHome()"><i class="fas fa-graduation-cap"></i> EduPro ONLINE</div>
        <div class="flex-gap">
            <button class="btn-icon btn-outline" onclick="app.toggleTheme()" title="Đổi giao diện"><i class="fas fa-adjust"></i></button>
            <div id="user-area" class="flex-gap"></div>
        </div>
    </header>

    <div class="container">
        <!-- 1. AUTH -->
        <div id="view-auth" class="card" style="max-width: 500px; margin: 40px auto;">
            <div style="text-align:center; margin-bottom:30px">
                <h1 style="background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin:0">Xin Chào</h1>
                <p style="color:var(--text-sub)">Hệ thống thi trực tuyến - Dữ liệu đám mây</p>
            </div>
            <div id="auth-forms">
                <div id="form-login">
                    <div class="input-group"><i class="fas fa-user"></i><input type="text" id="l-user" placeholder="Tên đăng nhập"></div>
                    <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="l-pass" placeholder="Mật khẩu"></div>
                    <div style="text-align: right; margin-bottom: 15px;"><a href="#" onclick="auth.forgotPass()" style="font-size: 0.9rem; color: var(--text-sub);">Quên mật khẩu?</a></div>
                    <button class="btn-primary" style="width:100%; padding:14px" onclick="auth.login()">ĐĂNG NHẬP NGAY</button>
                    <p style="text-align:center; margin-top:20px; font-size:0.9rem">Chưa có tài khoản? <a href="#" onclick="auth.switch('register')" style="color:var(--primary); font-weight:bold">Đăng ký</a></p>
                </div>
                <div id="form-register" class="hidden">
                    <div class="input-group"><i class="fas fa-font"></i><input type="text" id="r-name" placeholder="Họ và tên đầy đủ"></div>
                    <div class="input-group"><i class="fas fa-user-tag"></i><input type="text" id="r-user" placeholder="Tên đăng nhập"></div>
                    <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="r-email" placeholder="Email"></div>
                    <div class="input-group"><i class="fas fa-phone"></i><input type="tel" id="r-phone" placeholder="SĐT"></div>
                    <div class="input-group"><i class="fas fa-key"></i><input type="password" id="r-pass" placeholder="Mật khẩu"></div>
                    <button class="btn-primary" style="width:100%; padding:14px" onclick="auth.preRegister()">GỬI MÃ XÁC THỰC</button>
                    <p style="text-align:center; margin-top:20px; font-size:0.9rem">Đã có tài khoản? <a href="#" onclick="auth.switch('login')" style="color:var(--primary); font-weight:bold">Quay lại đăng nhập</a></p>
                </div>
            </div>
        </div>

        <!-- 2. TEACHER DASHBOARD -->
        <div id="view-teacher" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon" style="background:#6366f1"><i class="fas fa-folder-open"></i></div><div class="stat-info"><h4>Tổng đề thi</h4><p id="stat-quizzes">0</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#ec4899"><i class="fas fa-users"></i></div><div class="stat-info"><h4>Học sinh</h4><p id="stat-students">0</p></div></div>
                <div class="stat-card"><div class="stat-icon" style="background:#10b981"><i class="fas fa-chart-line"></i></div><div class="stat-info"><h4>Lượt làm bài</h4><p id="stat-attempts">0</p></div></div>
            </div>
            <div class="card flex-between" style="padding:15px">
                <div class="flex-gap" style="flex:1"><i class="fas fa-search" style="color:var(--text-sub)"></i><input type="text" id="t-search" placeholder="Tìm kiếm đề thi..." onkeyup="teacher.renderList()" style="border:none; padding:5px; background:transparent; width:100%"></div>
                <div class="flex-gap">
                    <button class="btn-outline" onclick="teacher.showUsers()"><i class="fas fa-user-friends"></i> QL Học sinh</button>
                    <button class="btn-primary" onclick="app.router('create-quiz')"><i class="fas fa-plus-circle"></i> Tạo đề mới</button>
                </div>
            </div>
            <h3 style="margin: 20px 0 10px"><i class="fas fa-list"></i> Danh sách đề thi</h3>
            <div id="teacher-list" class="quiz-grid"></div>
        </div>

        <!-- TEACHER USERS -->
        <div id="view-users" class="hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:20px"><h3><i class="fas fa-address-book"></i> Danh sách người dùng</h3><button class="btn-outline" onclick="app.router('teacher')">Quay lại</button></div>
                <div class="table-responsive"><table id="user-table"><thead><tr><th>Tên đăng nhập</th><th>Họ tên</th><th>Email</th><th>Vai trò</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>

        <!-- 3. CREATE QUIZ -->
        <div id="view-create-quiz" class="hidden">
            <div class="card">
                <div class="flex-between" style="padding-bottom:15px; border-bottom:1px solid var(--border); margin-bottom:20px"><h3><i class="fas fa-edit"></i> Soạn thảo đề thi</h3><button class="btn-outline" onclick="teacher.cancelEdit()">Hủy bỏ</button></div>
                <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px">
                    <input type="text" id="q-title" placeholder="Tiêu đề bài thi">
                    <input type="number" id="q-time" placeholder="Phút" value="45">
                    <input type="text" id="q-pass" placeholder="Mật khẩu (trống = công khai)">
                </div>
                <div id="editor-container"></div>
                <button class="btn-outline" style="width:100%; margin:20px 0; border-style:dashed" onclick="teacher.addUI()"><i class="fas fa-plus"></i> Thêm câu hỏi</button>
                <div class="flex-between"><div></div><button class="btn-primary" style="padding:12px 30px" onclick="teacher.save()">LƯU ĐỀ THI</button></div>
            </div>
        </div>

        <!-- 4. STUDENT DASHBOARD -->
        <div id="view-student" class="hidden">
            <div style="display:grid; grid-template-columns: 1fr 2.5fr; gap:20px; align-items:start">
                <div class="card" style="text-align:center">
                    <div style="width:100px; height:100px; border-radius:50%; background:linear-gradient(to right, var(--primary), var(--secondary)); margin:0 auto 15px; display:flex; align-items:center; justify-content:center; color:white; font-size:2.5rem;"><i class="fas fa-user-astronaut"></i></div>
                    <h3 id="profile-name">User</h3><p id="profile-role" style="color:var(--primary); font-weight:bold; font-size:0.9rem">STUDENT</p>
                    <div style="text-align:left; margin-top:20px; font-size:0.9rem">
                        <p><i class="fas fa-star" style="width:20px; color:var(--warning)"></i> Điểm TB: <span id="profile-avg" style="font-weight:bold">0.0</span></p>
                    </div>
                    <button class="btn-outline" style="width:100%; margin-top:15px" onclick="student.renderHistory()"><i class="fas fa-history"></i> Lịch sử thi</button>
                </div>
                <div>
                    <div class="card flex-between" style="padding:15px">
                        <h3 style="margin:0"><i class="fas fa-book-reader"></i> Đề thi hiện có</h3>
                        <div class="flex-gap"><i class="fas fa-search" style="color:var(--text-sub)"></i><input type="text" id="s-search" placeholder="Tìm đề thi..." onkeyup="student.renderDashboard()" style="border:none; background:transparent; width:200px"></div>
                    </div>
                    <div id="student-list" class="quiz-grid"></div>
                </div>
            </div>
        </div>

        <!-- 5. PRE QUIZ -->
        <div id="view-pre-quiz" class="hidden">
            <div class="card" style="max-width:550px; margin:40px auto; text-align:center">
                <i class="fas fa-rocket" style="font-size:4rem; color:var(--secondary); margin-bottom:20px"></i>
                <h2 id="pre-title" style="margin:0 0 10px">Title</h2>
                <div style="background:var(--bg-body); padding:20px; border-radius:12px; margin:20px 0; text-align:left">
                    <div class="flex-between"><span><i class="fas fa-user-tie"></i> Giáo viên:</span><b id="pre-author"></b></div>
                    <hr style="border:0; border-top:1px dashed var(--border); margin:10px 0">
                    <div class="flex-between"><span><i class="fas fa-clock"></i> Thời gian:</span><b><span id="pre-time"></span> phút</b></div>
                    <div class="flex-between" style="margin-top:10px"><span><i class="fas fa-question-circle"></i> Số câu hỏi:</span><b><span id="pre-len"></span> câu</b></div>
                </div>
                <div id="pass-area" class="hidden" style="margin-bottom:20px"><input type="password" id="exam-pass" placeholder="Nhập mật khẩu đề thi..." style="text-align:center; border:2px solid var(--primary)"></div>
                <div class="flex-gap"><button class="btn-outline" style="flex:1" onclick="app.goHome()">Quay lại</button><button class="btn-primary" style="flex:2" onclick="student.checkStart()">BẮT ĐẦU</button></div>
            </div>
        </div>

        <!-- 6. DOING QUIZ -->
        <div id="view-taking" class="hidden">
            <div class="flex-between" style="background:var(--bg-card); padding:15px 25px; position:sticky; top:80px; z-index:90; box-shadow:var(--shadow); border-radius:var(--radius); margin-bottom:20px">
                <div style="font-weight:bold; font-size:1.1rem; color:var(--primary)"><i class="fas fa-pencil-alt"></i> <span id="taking-title"></span></div>
                <div id="timer-box">00:00</div>
            </div>
            <div style="max-width: 900px; margin: 0 auto;"><div id="quiz-body"></div><div style="text-align:center; margin-top:40px; margin-bottom: 50px;"><button class="btn-primary" onclick="student.submit(false)" style="padding:16px 60px; font-size:1.2rem; border-radius: 30px;">NỘP BÀI</button></div></div>
        </div>

        <!-- 7. RESULT -->
        <div id="view-result" class="hidden">
            <div class="card" style="text-align:center; max-width:650px; margin:30px auto">
                <i class="fas fa-trophy" style="font-size:3rem; color:#fbbf24; margin-bottom:15px"></i>
                <h2 style="margin:0">Kết Quả</h2>
                <div style="display:flex; justify-content:center; gap:20px; margin:30px 0">
                    <div style="text-align:center"><div style="font-size:2.5rem; font-weight:800; color:var(--primary)" id="res-score">0</div><div>Điểm số</div></div>
                    <div style="border-right:1px solid var(--border)"></div>
                    <div style="text-align:center"><div style="font-size:2.5rem; font-weight:800; color:var(--success)" id="res-right">0</div><div>Câu đúng</div></div>
                </div>
                <div class="flex-gap" style="justify-content:center"><button class="btn-outline" onclick="student.toggleReview()">Xem đáp án</button><button class="btn-primary" onclick="app.goHome()">Về trang chủ</button></div>
            </div>
            <div id="review-area" class="hidden card"><div id="review-content"></div></div>
        </div>

        <!-- 8. REPORT -->
        <div id="view-report" class="hidden">
            <div class="card">
                <div class="flex-between"><h3 id="rp-title">Bảng xếp hạng</h3><button class="btn-outline" onclick="app.router('teacher')">Quay lại</button></div>
                <div class="table-responsive"><table id="rp-table"><thead><tr><th>Hạng</th><th>Học sinh</th><th>Điểm số</th><th>Thời gian</th><th>Ngày nộp</th></tr></thead><tbody id="rp-body"></tbody></table></div>
            </div>
        </div>

        <!-- 9. HISTORY -->
        <div id="view-history" class="hidden">
            <div class="card">
                <div class="flex-between" style="margin-bottom:20px"><h3><i class="fas fa-history"></i> Lịch sử làm bài</h3><button class="btn-outline" onclick="app.goHome()">Quay lại</button></div>
                <div class="table-responsive"><table id="his-table"><thead><tr><th>Tên đề thi</th><th>Giáo viên</th><th>Điểm số</th><th>Thời gian</th><th>Ngày</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH FIREBASE ---
        // BẠN HÃY THAY THẾ PHẦN BÊN DƯỚI BẰNG CODE BẠN COPY TỪ FIREBASE CONSOLE
        const firebaseConfig = {
           apiKey: "AIzaSyDioRcCSUJ5RzRrvNOa2TbIQ9c3LGH_H8I",
  authDomain: "edupro-quiz.firebaseapp.com",
  databaseURL: "https://edupro-quiz-default-rtdb.firebaseio.com",
  projectId: "edupro-quiz",
  storageBucket: "edupro-quiz.firebasestorage.app",
  messagingSenderId: "774943598702",
  appId: "1:774943598702:web:e809c227d1994620379e7f",
  measurementId: "G-64NL7PLMF9"
        };
        // ------------------------------------------------------------------

        // Khởi tạo Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const dbRef = firebase.database().ref();

        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        const notify = (msg, type='info') => {
            const colors = { info: 'var(--primary)', success: 'var(--success)', error: 'var(--danger)', warning: 'var(--warning)' };
            const div = document.createElement('div'); div.className = 'toast'; div.style.borderLeftColor = colors[type];
            div.innerHTML = `<i class="fas fa-info-circle" style="color:${colors[type]}"></i> <div>${msg}</div>`;
            $('#toast-container').appendChild(div);
            setTimeout(() => { div.style.transform='translateX(120%)'; setTimeout(()=>div.remove(),300); }, 3000);
        };

        // DB GLOBAL (Sync with Cloud)
        const DB = {
            users: [],
            quizzes: [],
            results: [],
            init: async () => {
                // Tải dữ liệu từ Firebase
                $('#view-loading').classList.remove('hidden');
                try {
                    const snapshot = await dbRef.once('value');
                    const data = snapshot.val() || {};
                    DB.users = data.users || [];
                    DB.quizzes = data.quizzes || [];
                    DB.results = data.results || [];
                    
                    // Tạo tài khoản Admin nếu chưa có
                    DB.checkAdmin();
                } catch (e) {
                    console.error(e);
                    // Nếu chưa cấu hình Firebase đúng
                    notify("Lỗi kết nối Server! Kiểm tra Config Firebase.", "error");
                } finally {
                    $('#view-loading').classList.add('hidden');
                }
            },
            save: (key) => {
                // Lưu mảng cụ thể lên Firebase
                if(key === 'users') dbRef.child('users').set(DB.users);
                if(key === 'quizzes') dbRef.child('quizzes').set(DB.quizzes);
                if(key === 'results') dbRef.child('results').set(DB.results);
            },
            checkAdmin: () => {
                const adminUser = "levandat2010";
                const adminPass = "Ledat2010@";
                const idx = DB.users.findIndex(u => u.username === adminUser);
                
                if (idx === -1) {
                    DB.users.push({
                        username: adminUser,
                        password: adminPass,
                        fullname: "Administrator",
                        email: "admin@edupro.com",
                        phone: "0999999999",
                        role: "teacher", // Teacher quyền cao nhất hiện tại
                        isAdmin: true,
                        joined: new Date().toISOString()
                    });
                    DB.save('users');
                    console.log("Đã khởi tạo tài khoản Admin: levandat2010");
                }
            }
        };

        const otpService = {
            code: null, temp: null, type: null,
            send: (contact) => {
                otpService.code = Math.floor(100000 + Math.random() * 900000).toString();
                alert(`[OTP SYSTEM]\nMã của bạn là: ${otpService.code}`); // Giả lập SMS
                $('#modal-otp').classList.remove('hidden');
            }
        };

        const auth = {
            user: null,
            switch: (t) => { $('#form-login').classList.toggle('hidden',t!=='login'); $('#form-register').classList.toggle('hidden',t!=='register'); },
            login: () => {
                const u = $('#l-user').value.trim(); const p = $('#l-pass').value.trim();
                const acc = DB.users.find(x => x.username === u && x.password === p);
                if(acc) {
                    auth.user = acc;
                    localStorage.setItem('edu_logged_user', JSON.stringify(acc)); // Lưu phiên đăng nhập
                    app.init();
                    notify('Đăng nhập thành công', 'success');
                } else notify('Sai tài khoản hoặc mật khẩu', 'error');
            },
            preRegister: () => {
                const name=$('#r-name').value, u=$('#r-user').value, mail=$('#r-email').value, p=$('#r-pass').value;
                if(!name || !u || !p) return notify('Điền đủ thông tin', 'error');
                if(DB.users.find(x => x.username === u)) return notify('Tên đăng nhập đã tồn tại', 'error');
                otpService.temp = { username:u, password:p, fullname:name, email:mail, role:'student', joined: new Date().toISOString() };
                otpService.type = 'REG';
                otpService.send(mail);
            },
            submitOTP: () => {
                if($('#otp-input').value === otpService.code) {
                    if(otpService.type === 'REG') {
                        DB.users.push(otpService.temp);
                        DB.save('users');
                        notify('Đăng ký thành công', 'success');
                        auth.switch('login');
                    }
                    $('#modal-otp').classList.add('hidden');
                } else notify('Mã OTP sai', 'error');
            },
            logout: () => {
                localStorage.removeItem('edu_logged_user');
                location.reload();
            }
        };

        const teacher = {
            editId: null,
            renderDashboard: () => {
                const myQ = DB.quizzes.filter(q => q.author === auth.user.username);
                $('#stat-quizzes').innerText = myQ.length;
                $('#stat-students').innerText = DB.users.filter(u=>u.role==='student').length;
                $('#stat-attempts').innerText = DB.results.filter(r => myQ.some(q=>q.id===r.quizId)).length;
                teacher.renderList();
            },
            renderList: () => {
                const k = $('#t-search').value.toLowerCase();
                const list = DB.quizzes.filter(q => q.author === auth.user.username && q.title.toLowerCase().includes(k));
                $('#teacher-list').innerHTML = list.map(q => `
                    <div class="quiz-item">
                        <span class="quiz-tag">${q.questions.length} câu</span>
                        <div style="font-weight:bold; margin-bottom:5px">${q.title}</div>
                        <div style="font-size:0.8rem; color:var(--text-sub)">Code: ${q.id}</div>
                        <div class="flex-gap" style="margin-top:15px">
                            <button class="btn-outline btn-icon" onclick="teacher.report(${q.id})"><i class="fas fa-chart-pie"></i></button>
                            <button class="btn-outline btn-icon" onclick="teacher.edit(${q.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn-danger btn-icon" onclick="teacher.del(${q.id})"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`).join('');
            },
            save: () => {
                const title = $('#q-title').value;
                const blocks = $$('.editor-block');
                if(!title || !blocks.length) return notify("Cần tiêu đề và câu hỏi", 'error');
                
                const questions = Array.from(blocks).map(b => {
                    const type = b.querySelector('.q-type').value;
                    const q = b.querySelector('.q-text').value;
                    const explain = b.querySelector('.q-explain').value;
                    let res = { type, q, explain, opts: [], correct: null };
                    if(type==='mc') {
                        res.opts = [b.querySelector('.opt-c').value, ...Array.from(b.querySelectorAll('.opt')).map(i=>i.value)];
                        res.correct = 0;
                    } else if (type==='tf') res.correct = b.querySelector('.tf-val').value;
                    else res.correct = b.querySelector('.sa-val').value;
                    return res;
                });

                const quiz = {
                    id: teacher.editId || Date.now(),
                    title,
                    time: parseInt($('#q-time').value)||45,
                    password: $('#q-pass').value,
                    author: auth.user.username,
                    questions,
                    created: new Date().toISOString()
                };

                if(teacher.editId) {
                    const idx = DB.quizzes.findIndex(q => q.id === teacher.editId);
                    DB.quizzes[idx] = quiz;
                } else DB.quizzes.push(quiz);
                
                DB.save('quizzes');
                notify("Đã lưu lên Cloud!", "success");
                teacher.cancelEdit();
            },
            addUI: (data=null) => {
                const div = document.createElement('div'); div.className = 'question-card editor-block';
                div.innerHTML = `
                    <div class="flex-between" style="margin-bottom:10px">
                        <select class="q-type" onchange="teacher.changeType(this)"><option value="mc">Trắc nghiệm</option><option value="tf">Đúng/Sai</option><option value="sa">Điền từ</option></select>
                        <button class="btn-danger btn-icon" onclick="this.closest('.editor-block').remove()"><i class="fas fa-times"></i></button>
                    </div>
                    <textarea class="q-text" rows="2" placeholder="Câu hỏi">${data?.q||''}</textarea>
                    <textarea class="q-explain" rows="1" placeholder="Giải thích">${data?.explain||''}</textarea>
                    <div class="q-content" style="margin-top:10px"></div>`;
                $('#editor-container').appendChild(div);
                const sel = div.querySelector('.q-type');
                if(data) sel.value = data.type;
                teacher.changeType(sel, data);
            },
            changeType: (el, data) => {
                const c = el.closest('.editor-block').querySelector('.q-content');
                if(el.value === 'mc') {
                    c.innerHTML = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
                        <input value="${data?.opts?.[0]||''}" class="opt-c" placeholder="ĐÚNG" style="border-color:var(--success)">
                        <input value="${data?.opts?.[1]||''}" class="opt" placeholder="Sai">
                        <input value="${data?.opts?.[2]||''}" class="opt" placeholder="Sai">
                        <input value="${data?.opts?.[3]||''}" class="opt" placeholder="Sai">
                    </div>`;
                } else if(el.value === 'tf') {
                    c.innerHTML = `<select class="tf-val"><option value="true">Đúng</option><option value="false">Sai</option></select>`;
                    if(data) c.querySelector('select').value = data.correct;
                } else {
                    c.innerHTML = `<input class="sa-val" placeholder="Đáp án đúng" value="${data?.correct||''}">`;
                }
            },
            edit: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                teacher.editId = id;
                $('#q-title').value = q.title; $('#q-time').value = q.time; $('#q-pass').value = q.password;
                $('#editor-container').innerHTML='';
                q.questions.forEach(qs => teacher.addUI(qs));
                app.router('create-quiz');
            },
            del: (id) => {
                if(confirm("Xóa đề này?")) {
                    DB.quizzes = DB.quizzes.filter(q => q.id !== id);
                    DB.save('quizzes');
                    teacher.renderDashboard();
                }
            },
            report: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                $('#rp-title').innerText = q.title;
                const data = DB.results.filter(r => r.quizId === id).sort((a,b)=>b.score - a.score);
                $('#rp-body').innerHTML = data.map((r,i) => `
                    <tr><td>${i+1}</td><td>${r.fullname}</td><td style="font-weight:bold; color:var(--primary)">${r.score}</td><td>${r.timeString}</td><td>${new Date(r.timestamp).toLocaleDateString()}</td></tr>
                `).join('') || '<tr><td colspan="5" style="text-align:center">Chưa có dữ liệu</td></tr>';
                app.router('report');
            },
            cancelEdit: () => { teacher.editId=null; app.router('teacher'); },
            showUsers: () => {
                $('#user-table tbody').innerHTML = DB.users.map(u => `<tr><td>${u.username}</td><td>${u.fullname}</td><td>${u.email||'-'}</td><td>${u.role}</td></tr>`).join('');
                app.router('users');
            }
        };

        const student = {
            quiz: null, questions: [], timer: null, timeLeft: 0,
            renderDashboard: () => {
                $('#profile-name').innerText = auth.user.fullname;
                const myRes = DB.results.filter(r => r.username === auth.user.username);
                $('#profile-avg').innerText = myRes.length ? (myRes.reduce((a,b)=>a+b.score,0)/myRes.length).toFixed(1) : '0.0';
                
                const k = $('#s-search').value.toLowerCase();
                const list = DB.quizzes.filter(q => q.title.toLowerCase().includes(k));
                $('#student-list').innerHTML = list.map(q => `
                    <div class="quiz-item" onclick="student.openStart(${q.id})">
                        <span class="quiz-tag">${q.questions.length} câu</span>
                        <div style="font-weight:bold; color:var(--primary)">${q.title}</div>
                        <div style="font-size:0.8rem; color:var(--text-sub)">GV: ${q.author}</div>
                        <div style="font-size:0.8rem; margin-top:5px">${q.password?'<i class="fas fa-lock"></i> Có mật khẩu':'<i class="fas fa-lock-open"></i> Miễn phí'}</div>
                    </div>`).join('');
            },
            openStart: (id) => {
                const q = DB.quizzes.find(x => x.id === id);
                student.quiz = q;
                $('#pre-title').innerText = q.title; $('#pre-author').innerText = q.author;
                $('#pre-time').innerText = q.time; $('#pre-len').innerText = q.questions.length;
                $('#pass-area').classList.toggle('hidden', !q.password);
                app.router('pre-quiz');
            },
            checkStart: () => {
                if(student.quiz.password && $('#exam-pass').value !== student.quiz.password) return notify('Sai mật khẩu', 'error');
                app.router('taking');
                $('#taking-title').innerText = student.quiz.title;
                student.timeLeft = student.quiz.time * 60;
                student.questions = student.quiz.questions.map(q => {
                    if(q.type === 'mc') {
                        let idxs = [0,1,2,3].sort(()=>Math.random()-0.5);
                        return {...q, optsDisplay: idxs.map(i=>q.opts[i]), trueIdx: idxs.indexOf(0)};
                    }
                    return q;
                });
                $('#quiz-body').innerHTML = student.questions.map((q,i) => `
                    <div class="question-card">
                        <div class="q-header"><span class="q-badge">Câu ${i+1}</span> ${q.q}</div>
                        <div class="q-options">${student.renderInput(q,i)}</div>
                    </div>`).join('');
                if(student.timer) clearInterval(student.timer);
                student.timer = setInterval(() => {
                    student.timeLeft--;
                    $('#timer-box').innerText = `${Math.floor(student.timeLeft/60)}:${(student.timeLeft%60).toString().padStart(2,'0')}`;
                    if(student.timeLeft<=0) student.submit(true);
                }, 1000);
            },
            renderInput: (q,idx) => {
                if(q.type === 'mc') return q.optsDisplay.map((o,i) => `<label class="opt-row"><input type="radio" name="answ-${idx}" value="${i}"> <span class="opt-text">${o}</span></label>`).join('');
                if(q.type === 'tf') return `<label class="opt-row"><input type="radio" name="answ-${idx}" value="true"> Đúng</label><label class="opt-row"><input type="radio" name="answ-${idx}" value="false"> Sai</label>`;
                return `<input type="text" name="answ-${idx}" class="sa-input" placeholder="Nhập đáp án...">`;
            },
            submit: (auto) => {
                if(!auto && !confirm("Nộp bài?")) return;
                clearInterval(student.timer);
                let correct = 0;
                const review = student.questions.map((q,i) => {
                    let isRight = false, uVal = '', rVal = '';
                    if(q.type==='mc') {
                        const el = $(`input[name="answ-${i}"]:checked`);
                        const val = el ? parseInt(el.value) : -1;
                        uVal = val!==-1 ? q.optsDisplay[val] : '-'; rVal = q.optsDisplay[q.trueIdx];
                        if(val === q.trueIdx) isRight = true;
                    } else if(q.type==='tf') {
                        const el = $(`input[name="answ-${i}"]:checked`);
                        uVal = el ? (el.value==='true'?'Đúng':'Sai') : '-'; rVal = q.correct==='true'?'Đúng':'Sai';
                        if(el && el.value===q.correct) isRight = true;
                    } else {
                        uVal = $(`input[name="answ-${i}"]`).value.trim(); rVal = q.correct;
                        if(uVal.toLowerCase() === rVal.toLowerCase()) isRight = true;
                    }
                    if(isRight) correct++;
                    return {q:q.q, u:uVal, r:rVal, right:isRight, explain:q.explain};
                });
                
                const score = parseFloat(((correct/student.questions.length)*10).toFixed(2));
                const timeTaken = (student.quiz.time*60) - student.timeLeft;
                const timeStr = `${Math.floor(timeTaken/60)}p ${timeTaken%60}s`;

                const result = {
                    id: Date.now(),
                    quizId: student.quiz.id,
                    username: auth.user.username,
                    fullname: auth.user.fullname,
                    score, timeSec: timeTaken, timeString: timeStr,
                    timestamp: Date.now()
                };
                
                DB.results.push(result);
                DB.save('results');

                $('#res-score').innerText = score; $('#res-right').innerText = `${correct}/${student.questions.length}`;
                $('#review-content').innerHTML = review.map(x => `
                    <div style="padding:10px; margin-bottom:10px; border-left:4px solid ${x.right?'green':'red'}; background:#f8fafc">
                        <div><b>${x.q}</b></div>
                        <div>Bạn chọn: ${x.u} | Đáp án: <b>${x.r}</b></div>
                        ${x.explain ? `<div style="color:gray; font-style:italic">Giải thích: ${x.explain}</div>` : ''}
                    </div>`).join('');
                app.router('result');
            },
            toggleReview: () => $('#review-area').classList.toggle('hidden'),
            renderHistory: () => {
                const h = DB.results.filter(r => r.username === auth.user.username).reverse();
                $('#his-table tbody').innerHTML = h.map(x => {
                    const q = DB.quizzes.find(q=>q.id===x.quizId);
                    return `<tr><td>${q?q.title:'Đề đã xóa'}</td><td>${q?q.author:'-'}</td><td>${x.score}</td><td>${x.timeString}</td><td>${new Date(x.timestamp).toLocaleDateString()}</td></tr>`;
                }).join('');
                app.router('history');
            }
        };

        const app = {
            async start() {
                // Tải dữ liệu trước
                await DB.init();
                
                // Kiểm tra đăng nhập cũ
                const cachedUser = localStorage.getItem('edu_logged_user');
                if(cachedUser) {
                    const u = JSON.parse(cachedUser);
                    // Kiểm tra xem user này còn tồn tại trên server không
                    const realUser = DB.users.find(x => x.username === u.username);
                    if(realUser) {
                        auth.user = realUser;
                        return app.init();
                    }
                }
                app.router('auth');
            },
            init: () => {
                $('#user-area').innerHTML = `<div style="text-align:right; font-weight:bold">${auth.user.fullname} <i class="fas fa-sign-out-alt" onclick="auth.logout()" style="cursor:pointer; margin-left:10px"></i></div>`;
                auth.user.role === 'teacher' ? app.router('teacher') : app.router('student');
            },
            router: (view) => {
                $$('.container > div').forEach(e => e.classList.add('hidden'));
                const t = $(`#view-${view}`); if(t) t.classList.remove('hidden');
                if(view==='teacher') teacher.renderDashboard();
                if(view==='student') student.renderDashboard();
                window.scrollTo(0,0);
            },
            toggleTheme: () => document.body.classList.toggle('dark-mode'),
            goHome: () => auth.user ? (auth.user.role==='teacher'?app.router('teacher'):app.router('student')) : app.router('auth')
        };

        // Chạy App
        app.start();

    </script>
</body>
</html>
